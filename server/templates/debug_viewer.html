<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í…œí”Œë¦¿ ë§¤ì¹­ ë””ë²„ê·¸ ë·°ì–´</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .info-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .info-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
        }
        .info-value {
            font-size: 1.5em;
            color: #4CAF50;
            text-align: center;
        }
        .camera-box {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        .camera-title {
            font-size: 1.8em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        .camera-stream {
            width: 100%;
            border-radius: 10px;
            background: #000;
            min-height: 480px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .camera-stream img {
            width: 100%;
            border-radius: 10px;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
        }
        .components-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
        }
        #components-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        #components-table th {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            font-weight: bold;
            border-bottom: 2px solid rgba(255,255,255,0.3);
        }
        #components-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #components-table tbody tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .save-btn {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 20px auto 0;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            transition: all 0.3s ease;
        }
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }
        .save-btn:active {
            transform: translateY(0);
        }
        .save-btn:disabled {
            background: rgba(150, 150, 150, 0.5);
            cursor: not-allowed;
            box-shadow: none;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }
        .notification.success {
            background: #4CAF50;
            color: #fff;
        }
        .notification.error {
            background: #f44336;
            color: #fff;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        /* OCR ê²°ê³¼ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .ocr-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .ocr-title {
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .ocr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .ocr-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 10px;
        }
        .ocr-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .ocr-value {
            font-size: 1.3em;
            font-weight: bold;
        }
        .ocr-value.success {
            color: #4CAF50;
        }
        .ocr-value.error {
            color: #f44336;
        }
        .ocr-value.warning {
            color: #ff9800;
        }
        .detected-text-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ í…œí”Œë¦¿ ë§¤ì¹­ ë””ë²„ê·¸ ë·°ì–´</h1>

        <div class="info-panel">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">ê¸°ì¤€ì  ìœ„ì¹˜</div>
                    <div class="info-value" id="reference-point">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ROI ìƒíƒœ</div>
                    <div class="info-value" id="confidence">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ê²€ì¶œ ê°œìˆ˜</div>
                    <div class="info-value" id="template-size">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">í”„ë ˆì„ í¬ê¸°</div>
                    <div class="info-value" id="frame-size">-</div>
                </div>
            </div>
        </div>

        <div class="camera-box">
            <div class="camera-title">ğŸ“· ì¢Œì¸¡ ì¹´ë©”ë¼ (ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° + ROI ê¸°ë°˜ YOLO)</div>
            <div class="camera-stream">
                <img id="camera-stream" alt="í…œí”Œë¦¿ ë§¤ì¹­ ê²°ê³¼" style="display:none;">
                <div id="loading-text">í”„ë ˆì„ ëŒ€ê¸° ì¤‘...</div>
            </div>
        </div>

        <div class="components-panel" style="display:none;" id="components-panel">
            <h2 style="text-align: center; margin-bottom: 20px;">ğŸ” ê²€ì¶œëœ ì»´í¬ë„ŒíŠ¸ ìƒì„¸ ì •ë³´</h2>
            <div class="table-container">
                <table id="components-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ë¶€í’ˆ íƒ€ì…</th>
                            <th>ì ˆëŒ€ ì¢Œí‘œ (X, Y)</th>
                            <th>ìƒëŒ€ ì¢Œí‘œ (ê¸°ì¤€ì  0,0)</th>
                            <th>ë°”ìš´ë”© ë°•ìŠ¤ (X1, Y1, X2, Y2)</th>
                            <th>ì‹ ë¢°ë„</th>
                        </tr>
                    </thead>
                    <tbody id="components-tbody">
                        <tr><td colspan="6" style="text-align: center;">ê²€ì¶œëœ ì»´í¬ë„ŒíŠ¸ ì—†ìŒ</td></tr>
                    </tbody>
                </table>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px;">
                <button class="save-btn" id="save-bc-btn" onclick="saveReferenceComponents('BC')" disabled style="margin: 0;">
                    ğŸ’¾ ê¸°ì¤€ ë°°ì¹˜ ì €ì¥ (BC)
                </button>
                <button class="save-btn" id="save-ft-btn" onclick="saveReferenceComponents('FT')" disabled style="margin: 0; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                    ğŸ’¾ ê¸°ì¤€ ë°°ì¹˜ ì €ì¥ (FT)
                </button>
                <button class="save-btn" id="save-rs-btn" onclick="saveReferenceComponents('RS')" disabled style="margin: 0; background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%);">
                    ğŸ’¾ ê¸°ì¤€ ë°°ì¹˜ ì €ì¥ (RS)
                </button>
            </div>
        </div>

        <!-- ì‹œë¦¬ì–¼ ë„˜ë²„ OCR ê²°ê³¼ íŒ¨ë„ -->
        <div class="ocr-panel" id="ocr-panel">
            <div class="ocr-title">ğŸ”¤ ì‹œë¦¬ì–¼ ë„˜ë²„ OCR ê²€ì¶œ ê²°ê³¼ (ìš°ì¸¡ ì¹´ë©”ë¼)</div>

            <div class="ocr-grid">
                <div class="ocr-item">
                    <div class="ocr-label">ìƒíƒœ</div>
                    <div class="ocr-value" id="ocr-status">ëŒ€ê¸° ì¤‘...</div>
                </div>
                <div class="ocr-item">
                    <div class="ocr-label">ì‹œë¦¬ì–¼ ë„˜ë²„</div>
                    <div class="ocr-value" id="ocr-serial">-</div>
                </div>
                <div class="ocr-item">
                    <div class="ocr-label">ì œí’ˆ ì½”ë“œ</div>
                    <div class="ocr-value" id="ocr-product-code">-</div>
                </div>
                <div class="ocr-item">
                    <div class="ocr-label">OCR ì‹ ë¢°ë„</div>
                    <div class="ocr-value" id="ocr-confidence">-</div>
                </div>
                <div class="ocr-item">
                    <div class="ocr-label">ì²˜ë¦¬ ì‹œê°„</div>
                    <div class="ocr-value" id="ocr-time">-</div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <div class="ocr-label" style="text-align: center; font-size: 1.1em;">ê²€ì¶œëœ ì›ë³¸ í…ìŠ¤íŠ¸</div>
                <div class="detected-text-box" id="ocr-detected-text">í…ìŠ¤íŠ¸ ì—†ìŒ</div>
            </div>

            <!-- OCR ì²˜ë¦¬ ì´ë¯¸ì§€ í‘œì‹œ -->
            <div style="margin-top: 20px;">
                <div class="ocr-label" style="text-align: center; font-size: 1.1em;">ğŸ“· OCR ì „ì²˜ë¦¬ ì™„ë£Œ ì´ë¯¸ì§€ (íšŒì „ + ì—…ìŠ¤ì¼€ì¼ + CLAHE + ì„ ëª…í™” + í…ìŠ¤íŠ¸ êµµê²Œ)</div>
                <div style="text-align: center; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px;">
                    <img id="ocr-image" src="" alt="OCR ì´ë¯¸ì§€ ì—†ìŒ" style="max-width: 100%; height: auto; border-radius: 8px; display: none;">
                    <div id="ocr-image-placeholder" style="color: #999; padding: 40px;">ì´ë¯¸ì§€ ëŒ€ê¸° ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ë¶€í’ˆ ê²€ì¦ ê²°ê³¼ íŒ¨ë„ -->
        <div class="ocr-panel" id="verification-panel" style="display: none;">
            <div class="ocr-title">âœ… ë¶€í’ˆ ê²€ì¦ ê²°ê³¼ (ì œí’ˆë³„ ë¶€í’ˆ ë°°ì¹˜ ê²€ì¦)</div>

            <div class="ocr-grid">
                <div class="ocr-item">
                    <div class="ocr-label">ìµœì¢… íŒì •</div>
                    <div class="ocr-value" id="verification-decision" style="font-size: 1.5em;">ëŒ€ê¸° ì¤‘...</div>
                </div>
                <div class="ocr-item">
                    <div class="ocr-label">ì œí’ˆ ì½”ë“œ</div>
                    <div class="ocr-value" id="verification-product-code">-</div>
                </div>
                <div class="ocr-item">
                    <div class="ocr-label">ì‹œë¦¬ì–¼ ë„˜ë²„</div>
                    <div class="ocr-value" id="verification-serial">-</div>
                </div>
                <div class="ocr-item">
                    <div class="ocr-label">GPIO í•€</div>
                    <div class="ocr-value" id="verification-gpio">-</div>
                </div>
                <div class="ocr-item">
                    <div class="ocr-label">í…œí”Œë¦¿ ë§¤ì¹­</div>
                    <div class="ocr-value" id="verification-template">-</div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <div class="ocr-label" style="text-align: center; font-size: 1.2em; margin-bottom: 15px;">ğŸ“Š ê²€ì¦ ìš”ì•½</div>
                <div class="ocr-grid">
                    <div class="ocr-item" style="background: rgba(76, 175, 80, 0.2);">
                        <div class="ocr-label">ì •ìƒ ë¶€í’ˆ</div>
                        <div class="ocr-value success" id="verification-correct">0</div>
                    </div>
                    <div class="ocr-item" style="background: rgba(255, 152, 0, 0.2);">
                        <div class="ocr-label">ìœ„ì¹˜ ì˜¤ë¥˜</div>
                        <div class="ocr-value warning" id="verification-misplaced">0</div>
                    </div>
                    <div class="ocr-item" style="background: rgba(244, 67, 54, 0.2);">
                        <div class="ocr-label">ë¶€í’ˆ ëˆ„ë½</div>
                        <div class="ocr-value error" id="verification-missing">0</div>
                    </div>
                    <div class="ocr-item" style="background: rgba(156, 39, 176, 0.2);">
                        <div class="ocr-label">ì¶”ê°€ ë¶€í’ˆ</div>
                        <div class="ocr-value" id="verification-extra">0</div>
                    </div>
                    <div class="ocr-item">
                        <div class="ocr-label">ê¸°ì¤€ ë¶€í’ˆ ìˆ˜</div>
                        <div class="ocr-value" id="verification-total-ref">0</div>
                    </div>
                    <div class="ocr-item">
                        <div class="ocr-label">ê²€ì¶œ ë¶€í’ˆ ìˆ˜</div>
                        <div class="ocr-value" id="verification-total-detected">0</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;" id="verification-details-container">
                <div class="ocr-label" style="text-align: center; font-size: 1.1em; margin-bottom: 10px;">ğŸ” ìƒì„¸ ì •ë³´</div>

                <!-- ëˆ„ë½ ë¶€í’ˆ ëª©ë¡ -->
                <div id="missing-details" style="display: none; margin-top: 15px;">
                    <div style="background: rgba(244, 67, 54, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #f44336;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #f44336;">âŒ ëˆ„ë½ ë¶€í’ˆ</div>
                        <div id="missing-list" style="font-family: 'Courier New', monospace; font-size: 0.95em;"></div>
                    </div>
                </div>

                <!-- ìœ„ì¹˜ ì˜¤ë¥˜ ë¶€í’ˆ ëª©ë¡ -->
                <div id="misplaced-details" style="display: none; margin-top: 15px;">
                    <div style="background: rgba(255, 152, 0, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #ff9800;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #ff9800;">âš ï¸ ìœ„ì¹˜ ì˜¤ë¥˜ ë¶€í’ˆ</div>
                        <div id="misplaced-list" style="font-family: 'Courier New', monospace; font-size: 0.95em;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            âœ¨ í…œí”Œë¦¿ ë§¤ì¹­ ë””ë²„ê·¸ ì‹œìŠ¤í…œ v2.0 | Flask Server | WebSocket Real-time
        </div>
    </div>

    <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
    <div id="notification" class="notification"></div>

    <script>
        // WebSocket ì—°ê²°
        const socket = io();

        // WebSocket ì—°ê²° ì´ë²¤íŠ¸
        socket.on('connect', () => {
            console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
        });

        socket.on('disconnect', () => {
            console.log('âŒ WebSocket ì—°ê²° ì¢…ë£Œ');
        });

        socket.on('connect_error', (error) => {
            console.error('âŒ WebSocket ì—°ê²° ì˜¤ë¥˜:', error);
        });

        // DOM ìš”ì†Œ
        const imgElement = document.getElementById('camera-stream');
        const loadingText = document.getElementById('loading-text');
        const refPointElement = document.getElementById('reference-point');
        const confidenceElement = document.getElementById('confidence');
        const templateSizeElement = document.getElementById('template-size');
        const frameSizeElement = document.getElementById('frame-size');
        const saveBcBtn = document.getElementById('save-bc-btn');
        const saveFtBtn = document.getElementById('save-ft-btn');
        const saveRsBtn = document.getElementById('save-rs-btn');
        const notification = document.getElementById('notification');

        // í˜„ì¬ ê²€ì¶œëœ ì»´í¬ë„ŒíŠ¸ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
        let currentComponentsData = [];

        // í”„ë ˆì„ ì—…ë°ì´íŠ¸ ìˆ˜ì‹  (ëª¨ë“  ì •ë³´ í¬í•¨)
        socket.on('frame_update', (data) => {
            console.log('ğŸ“¥ í”„ë ˆì„ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data.camera_id, data);

            if (data.camera_id === 'left') {
                // ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                if (data.image) {
                    imgElement.src = 'data:image/jpeg;base64,' + data.image;
                    imgElement.style.display = 'block';
                    loadingText.style.display = 'none';
                }

                // ROI ìƒíƒœ ì—…ë°ì´íŠ¸
                if (data.roi_status) {
                    if (data.roi_status === 'in_roi') {
                        confidenceElement.textContent = 'âœ… ROI ì•ˆ';
                        confidenceElement.style.color = '#4CAF50';
                    } else if (data.roi_status === 'out_of_roi') {
                        confidenceElement.textContent = 'âš ï¸ ROI ë°–';
                        confidenceElement.style.color = '#FFC107';
                    } else {
                        confidenceElement.textContent = data.roi_status;
                        confidenceElement.style.color = '#FFF';
                    }
                }

                // ê²€ì¶œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                if (data.boxes_count !== undefined) {
                    templateSizeElement.textContent = `${data.boxes_count}ê°œ`;
                    templateSizeElement.style.color = data.boxes_count > 0 ? '#4CAF50' : '#FFF';
                }

                // í”„ë ˆì„ í¬ê¸° ì—…ë°ì´íŠ¸
                if (data.frame_shape) {
                    const [height, width, channels] = data.frame_shape;
                    frameSizeElement.textContent = `${width}x${height}`;
                }

                // ì»´í¬ë„ŒíŠ¸ ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
                const componentsData = data.boxes_data || [];
                currentComponentsData = componentsData;  // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                updateComponentsTable(componentsData);

                // ì €ì¥ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” (ëª¨ë“  ì œí’ˆ ì½”ë“œ ë²„íŠ¼)
                if (componentsData.length > 0) {
                    saveBcBtn.disabled = false;
                    saveFtBtn.disabled = false;
                    saveRsBtn.disabled = false;
                } else {
                    saveBcBtn.disabled = true;
                    saveFtBtn.disabled = true;
                    saveRsBtn.disabled = true;
                }
            } else if (data.camera_id === 'right') {
                // ìš°ì¸¡ ì¹´ë©”ë¼ (OCR) ë°ì´í„° ì²˜ë¦¬
                const ocrStatus = document.getElementById('ocr-status');
                const ocrSerial = document.getElementById('ocr-serial');
                const ocrProductCode = document.getElementById('ocr-product-code');
                const ocrConfidence = document.getElementById('ocr-confidence');
                const ocrTime = document.getElementById('ocr-time');
                const ocrDetectedText = document.getElementById('ocr-detected-text');

                // ìƒíƒœ ì—…ë°ì´íŠ¸
                if (data.serial_number) {
                    ocrStatus.textContent = 'âœ… ê²€ì¶œ ì„±ê³µ';
                    ocrStatus.className = 'ocr-value success';
                } else if (data.error) {
                    ocrStatus.textContent = 'âŒ ê²€ì¶œ ì‹¤íŒ¨';
                    ocrStatus.className = 'ocr-value error';
                } else {
                    ocrStatus.textContent = 'âš ï¸ ì²˜ë¦¬ ì¤‘...';
                    ocrStatus.className = 'ocr-value warning';
                }

                // ì‹œë¦¬ì–¼ ë„˜ë²„
                ocrSerial.textContent = data.serial_number || '-';
                ocrSerial.className = data.serial_number ? 'ocr-value success' : 'ocr-value';

                // ì œí’ˆ ì½”ë“œ
                ocrProductCode.textContent = data.product_code || '-';
                ocrProductCode.className = data.product_code ? 'ocr-value success' : 'ocr-value';

                // OCR ì‹ ë¢°ë„
                if (data.ocr_confidence !== undefined && data.ocr_confidence !== null) {
                    const confidencePercent = (data.ocr_confidence * 100).toFixed(1) + '%';
                    ocrConfidence.textContent = confidencePercent;
                    ocrConfidence.className = data.ocr_confidence > 0.8 ? 'ocr-value success' : 'ocr-value warning';
                } else {
                    ocrConfidence.textContent = '-';
                    ocrConfidence.className = 'ocr-value';
                }

                // ì²˜ë¦¬ ì‹œê°„
                if (data.timestamp) {
                    const time = new Date(data.timestamp).toLocaleTimeString('ko-KR');
                    ocrTime.textContent = time;
                }

                // ê²€ì¶œëœ ì›ë³¸ í…ìŠ¤íŠ¸
                if (data.detected_text) {
                    ocrDetectedText.textContent = data.detected_text;
                } else {
                    ocrDetectedText.textContent = 'í…ìŠ¤íŠ¸ ì—†ìŒ';
                }
            }
        });

        // ì»´í¬ë„ŒíŠ¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateComponentsTable(components) {
            const tbody = document.getElementById('components-tbody');
            const panel = document.getElementById('components-panel');

            if (!components || components.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ê²€ì¶œëœ ì»´í¬ë„ŒíŠ¸ ì—†ìŒ</td></tr>';
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            tbody.innerHTML = '';

            components.forEach((comp, index) => {
                const row = tbody.insertRow();

                // ìƒëŒ€ ì¢Œí‘œ í‘œì‹œ (ê¸°ì¤€ì  ê¸°ì¤€)
                let relativeCoordsHtml = '-';
                if (comp.relative_center) {
                    const relX = Math.round(comp.relative_center[0]);
                    const relY = Math.round(comp.relative_center[1]);
                    relativeCoordsHtml = `<span style="color: #4CAF50;">(${relX}, ${relY})</span>`;
                }

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${comp.class_name || 'Unknown'}</strong></td>
                    <td>(${Math.round(comp.center[0])}, ${Math.round(comp.center[1])})</td>
                    <td>${relativeCoordsHtml}</td>
                    <td>(${Math.round(comp.bbox[0])}, ${Math.round(comp.bbox[1])}, ${Math.round(comp.bbox[2])}, ${Math.round(comp.bbox[3])})</td>
                    <td>${(comp.confidence * 100).toFixed(1)}%</td>
                `;
            });
        }

        // OCR ê²°ê³¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateOCRPanel(ocrData) {
            const statusEl = document.getElementById('ocr-status');
            const serialEl = document.getElementById('ocr-serial');
            const productCodeEl = document.getElementById('ocr-product-code');
            const confidenceEl = document.getElementById('ocr-confidence');
            const timeEl = document.getElementById('ocr-time');
            const detectedTextEl = document.getElementById('ocr-detected-text');

            if (!ocrData || Object.keys(ocrData).length === 0) {
                statusEl.textContent = 'ëŒ€ê¸° ì¤‘...';
                statusEl.className = 'ocr-value';
                serialEl.textContent = '-';
                productCodeEl.textContent = '-';
                confidenceEl.textContent = '-';
                timeEl.textContent = '-';
                detectedTextEl.textContent = 'í…ìŠ¤íŠ¸ ì—†ìŒ';
                return;
            }

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            if (ocrData.status === 'ok') {
                statusEl.textContent = 'âœ… ê²€ì¶œ ì„±ê³µ';
                statusEl.className = 'ocr-value success';

                // ì‹œë¦¬ì–¼ ë„˜ë²„
                serialEl.textContent = ocrData.serial_number || '-';
                serialEl.className = 'ocr-value success';

                // ì œí’ˆ ì½”ë“œ
                productCodeEl.textContent = ocrData.product_code || '-';
                productCodeEl.className = 'ocr-value success';
            } else {
                statusEl.textContent = 'âŒ ê²€ì¶œ ì‹¤íŒ¨';
                statusEl.className = 'ocr-value error';

                serialEl.textContent = 'ë¯¸ê²€ì¶œ';
                serialEl.className = 'ocr-value error';

                productCodeEl.textContent = 'ë¯¸ê²€ì¶œ';
                productCodeEl.className = 'ocr-value error';
            }

            // ì‹ ë¢°ë„
            if (ocrData.confidence !== undefined && ocrData.confidence > 0) {
                const conf = (ocrData.confidence * 100).toFixed(1);
                confidenceEl.textContent = `${conf}%`;

                // ì‹ ë¢°ë„ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                if (ocrData.confidence >= 0.7) {
                    confidenceEl.className = 'ocr-value success';
                } else if (ocrData.confidence >= 0.4) {
                    confidenceEl.className = 'ocr-value warning';
                } else {
                    confidenceEl.className = 'ocr-value error';
                }
            } else {
                confidenceEl.textContent = '-';
                confidenceEl.className = 'ocr-value';
            }

            // ì²˜ë¦¬ ì‹œê°„
            if (ocrData.inference_time_ms !== undefined) {
                timeEl.textContent = `${ocrData.inference_time_ms.toFixed(1)} ms`;
                timeEl.className = 'ocr-value';
            } else {
                timeEl.textContent = '-';
            }

            // ê²€ì¶œëœ í…ìŠ¤íŠ¸
            if (ocrData.detected_text) {
                detectedTextEl.textContent = ocrData.detected_text;
                if (ocrData.status === 'ok') {
                    detectedTextEl.style.color = '#4CAF50';
                } else {
                    detectedTextEl.style.color = '#ff9800';
                }
            } else {
                detectedTextEl.textContent = 'í…ìŠ¤íŠ¸ ì—†ìŒ';
                detectedTextEl.style.color = '#999';
            }

            // OCR ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
            const ocrImageEl = document.getElementById('ocr-image');
            const ocrImagePlaceholderEl = document.getElementById('ocr-image-placeholder');
            if (ocrData.image) {
                ocrImageEl.src = 'data:image/jpeg;base64,' + ocrData.image;
                ocrImageEl.style.display = 'block';
                ocrImagePlaceholderEl.style.display = 'none';
            } else {
                ocrImageEl.style.display = 'none';
                ocrImagePlaceholderEl.style.display = 'block';
            }
        }

        // ê²€ì¦ ê²°ê³¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateVerificationPanel(verificationData) {
            const panelEl = document.getElementById('verification-panel');

            if (!verificationData || Object.keys(verificationData).length === 0) {
                panelEl.style.display = 'none';
                return;
            }

            // íŒ¨ë„ í‘œì‹œ
            panelEl.style.display = 'block';

            // ìµœì¢… íŒì •
            const decisionEl = document.getElementById('verification-decision');
            const decisionText = verificationData.decision_text || verificationData.decision || '-';
            decisionEl.textContent = decisionText;

            // íŒì •ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
            if (verificationData.decision === 'normal') {
                decisionEl.className = 'ocr-value success';
                decisionEl.textContent = 'ğŸŸ¢ ' + decisionText;
            } else if (verificationData.decision === 'missing') {
                decisionEl.className = 'ocr-value warning';
                decisionEl.textContent = 'ğŸŸ¡ ' + decisionText;
            } else if (verificationData.decision === 'position_error') {
                decisionEl.className = 'ocr-value warning';
                decisionEl.textContent = 'ğŸŸ¡ ' + decisionText;
            } else if (verificationData.decision === 'discard') {
                decisionEl.className = 'ocr-value error';
                decisionEl.textContent = 'ğŸ”´ ' + decisionText;
            } else {
                decisionEl.className = 'ocr-value';
            }

            // ì œí’ˆ ì •ë³´
            document.getElementById('verification-product-code').textContent = verificationData.product_code || '-';
            document.getElementById('verification-serial').textContent = verificationData.serial_number || '-';
            document.getElementById('verification-gpio').textContent = verificationData.gpio_pin ? `GPIO ${verificationData.gpio_pin}` : '-';

            // í…œí”Œë¦¿ ë§¤ì¹­ ìƒíƒœ
            const templateEl = document.getElementById('verification-template');
            if (verificationData.template_match_success) {
                templateEl.textContent = 'âœ… ì„±ê³µ';
                templateEl.className = 'ocr-value success';
            } else {
                templateEl.textContent = 'âŒ ì‹¤íŒ¨';
                templateEl.className = 'ocr-value error';
            }

            // ê²€ì¦ ìš”ì•½
            if (verificationData.summary) {
                document.getElementById('verification-correct').textContent = verificationData.summary.correct_count || 0;
                document.getElementById('verification-misplaced').textContent = verificationData.summary.position_error_count || 0;
                document.getElementById('verification-missing').textContent = verificationData.summary.missing_count || 0;
                document.getElementById('verification-extra').textContent = verificationData.summary.extra_count || 0;
                document.getElementById('verification-total-ref').textContent = verificationData.summary.total_reference || 0;
                document.getElementById('verification-total-detected').textContent = verificationData.summary.total_detected || 0;
            }

            // ìƒì„¸ ì •ë³´ - ëˆ„ë½ ë¶€í’ˆ
            const missingDetailsEl = document.getElementById('missing-details');
            const missingListEl = document.getElementById('missing-list');
            if (verificationData.details && verificationData.details.missing && verificationData.details.missing.length > 0) {
                missingDetailsEl.style.display = 'block';
                const missingHtml = verificationData.details.missing.map((item, index) => {
                    return `${index + 1}. ${item.class} - ê¸°ì¤€ ìœ„ì¹˜: (${Math.round(item.center[0])}, ${Math.round(item.center[1])})`;
                }).join('<br>');
                missingListEl.innerHTML = missingHtml;
            } else {
                missingDetailsEl.style.display = 'none';
            }

            // ìƒì„¸ ì •ë³´ - ìœ„ì¹˜ ì˜¤ë¥˜ ë¶€í’ˆ
            const misplacedDetailsEl = document.getElementById('misplaced-details');
            const misplacedListEl = document.getElementById('misplaced-list');
            if (verificationData.details && verificationData.details.misplaced && verificationData.details.misplaced.length > 0) {
                misplacedDetailsEl.style.display = 'block';
                const misplacedHtml = verificationData.details.misplaced.map((item, index) => {
                    const offset = item.offset ? Math.round(item.offset) : '-';
                    return `${index + 1}. ${item.class} - ê¸°ì¤€: (${Math.round(item.expected[0])}, ${Math.round(item.expected[1])}) â†’ ì‹¤ì œ: (${Math.round(item.actual[0])}, ${Math.round(item.actual[1])}) (ì˜¤ì°¨: ${offset}px)`;
                }).join('<br>');
                misplacedListEl.innerHTML = misplacedHtml;
            } else {
                misplacedDetailsEl.style.display = 'none';
            }
        }

        // OCR ë° ê²€ì¦ ê²°ê³¼ ì£¼ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸° (500msë§ˆë‹¤)
        setInterval(() => {
            fetch('/api/latest_results')
                .then(response => response.json())
                .then(data => {
                    // OCR ê²°ê³¼ ì—…ë°ì´íŠ¸
                    if (data.serial_ocr) {
                        updateOCRPanel(data.serial_ocr);
                    }
                    // ê²€ì¦ ê²°ê³¼ ì—…ë°ì´íŠ¸
                    if (data.verification) {
                        updateVerificationPanel(data.verification);

                        // OCR ì „ì²˜ë¦¬ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ â­
                        const ocrImageEl = document.getElementById('ocr-image');
                        const ocrImagePlaceholderEl = document.getElementById('ocr-image-placeholder');
                        if (data.verification.ocr_preprocessed_image) {
                            ocrImageEl.src = 'data:image/jpeg;base64,' + data.verification.ocr_preprocessed_image;
                            ocrImageEl.style.display = 'block';
                            ocrImagePlaceholderEl.style.display = 'none';
                        } else {
                            ocrImageEl.style.display = 'none';
                            ocrImagePlaceholderEl.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                });
        }, 500);

        // ROI ìƒíƒœ ìˆ˜ì‹ 
        socket.on('roi_status', (data) => {
            console.log('ğŸ“¥ ROI ìƒíƒœ ìˆ˜ì‹ :', data);

            if (data.camera_id === 'left') {
                // ê¸°ì¤€ì  ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                if (data.reference_point) {
                    const [x, y] = data.reference_point;
                    refPointElement.textContent = `(${x}, ${y})`;

                    if (data.status === 'in_roi') {
                        refPointElement.style.color = '#4CAF50';  // ì´ˆë¡ - ROI ì•ˆ
                    } else {
                        refPointElement.style.color = '#FFC107';  // ë…¸ë‘ - ROI ë°–
                    }
                }
            }
        });

        // YOLO ê²€ì¶œ ê²°ê³¼ ìˆ˜ì‹  (ROI ì•ˆì— ìˆì„ ë•Œë§Œ)
        socket.on('yolo_result', (data) => {
            console.log('ğŸ“¥ YOLO ê²°ê³¼ ìˆ˜ì‹ :', data);

            if (data.camera_id === 'left') {
                // YOLO ë°•ì‹± ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                if (data.image) {
                    imgElement.src = 'data:image/jpeg;base64,' + data.image;
                    imgElement.style.display = 'block';
                    loadingText.style.display = 'none';
                }

                // ë§¤ì¹­ ì‹ ë¢°ë„ ì—…ë°ì´íŠ¸ (YOLO ì‹ ë¢°ë„)
                if (data.confidence !== undefined) {
                    const conf = (data.confidence * 100).toFixed(2);
                    confidenceElement.textContent = `${conf}%`;

                    // ì‹ ë¢°ë„ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                    if (data.confidence >= 0.9) {
                        confidenceElement.style.color = '#4CAF50';  // ì´ˆë¡
                    } else if (data.confidence >= 0.7) {
                        confidenceElement.style.color = '#FFC107';  // ë…¸ë‘
                    } else {
                        confidenceElement.style.color = '#ff5555';  // ë¹¨ê°•
                    }
                }

                // í…œí”Œë¦¿ í¬ê¸° â†’ YOLO ê²€ì¶œ ê°œìˆ˜ë¡œ ë³€ê²½
                if (data.boxes_count !== undefined) {
                    templateSizeElement.textContent = `${data.boxes_count}ê°œ`;
                }

                // í”„ë ˆì„ í¬ê¸° ì—…ë°ì´íŠ¸
                if (data.image) {
                    const sizeKB = (data.image.length / 1024).toFixed(1);
                    frameSizeElement.textContent = `${sizeKB} KB`;
                }
            }
        });

        // ROI ê±´ë„ˆë›°ê¸° ì•Œë¦¼
        socket.on('roi_skipped', (data) => {
            console.log('âš ï¸ YOLO ê±´ë„ˆë›°ê¸°:', data);

            if (data.camera_id === 'left') {
                confidenceElement.textContent = 'ROI ë°–';
                confidenceElement.style.color = '#FFC107';
                templateSizeElement.textContent = '-';
            }
        });

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // ê¸°ì¤€ ë¶€í’ˆ ë°°ì¹˜ ì €ì¥ í•¨ìˆ˜
        async function saveReferenceComponents(productCode) {
            if (currentComponentsData.length === 0) {
                showNotification('ê²€ì¶œëœ ì»´í¬ë„ŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // í´ë¦­í•œ ë²„íŠ¼ ì°¾ê¸°
            let clickedBtn;
            let originalText;
            if (productCode === 'BC') {
                clickedBtn = saveBcBtn;
                originalText = 'ğŸ’¾ ê¸°ì¤€ ë°°ì¹˜ ì €ì¥ (BC)';
            } else if (productCode === 'FT') {
                clickedBtn = saveFtBtn;
                originalText = 'ğŸ’¾ ê¸°ì¤€ ë°°ì¹˜ ì €ì¥ (FT)';
            } else if (productCode === 'RS') {
                clickedBtn = saveRsBtn;
                originalText = 'ğŸ’¾ ê¸°ì¤€ ë°°ì¹˜ ì €ì¥ (RS)';
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            clickedBtn.disabled = true;
            clickedBtn.textContent = 'ğŸ’¾ ì €ì¥ ì¤‘...';

            try {
                const response = await fetch('/save_reference_components', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_code: productCode,
                        components: currentComponentsData,
                        tolerance_px: 30.0  // ì¹´ë©”ë¼ ê±°ë¦¬ ì°¨ì´ ê³ ë ¤í•œ í—ˆìš© ì˜¤ì°¨
                    })
                });

                const result = await response.json();

                if (response.ok && result.status === 'ok') {
                    showNotification(`âœ… ${productCode} ì œí’ˆ ê¸°ì¤€ ë°°ì¹˜ ì €ì¥ ì™„ë£Œ (${result.components_saved}ê°œ)`, 'success');
                    console.log(`âœ… ${productCode} ê¸°ì¤€ ë¶€í’ˆ ë°°ì¹˜ ì €ì¥ ì„±ê³µ:`, result);
                } else {
                    showNotification(`âŒ ${productCode} ì €ì¥ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    console.error(`âŒ ${productCode} ì €ì¥ ì‹¤íŒ¨:`, result);
                }
            } catch (error) {
                showNotification(`âŒ ì„œë²„ ì˜¤ë¥˜: ${error.message}`, 'error');
                console.error('âŒ ì„œë²„ ì˜¤ë¥˜:', error);
            } finally {
                // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                clickedBtn.disabled = false;
                clickedBtn.textContent = originalText;
            }
        }

        console.log('âœ… ì‹¤ì‹œê°„ í”„ë ˆì„ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘...');
    </script>
</body>
